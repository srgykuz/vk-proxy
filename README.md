# vk-proxy

Проксирование интернет-трафика через ВКонтакте используя VK API. Цель этого проекта - обход белого списка и получение минимального доступа к глобальному интернету.

**vk-proxy не может быть использован для полноценной замены VPN и прокси.** VK API имеет жесткие ограничения, поэтому с помощью этой программы вы едва сможете использовать, например, Google или Wikipedia, не говоря уже о более ресурсоемких сайтах и приложениях.

Передаваемый трафик зашифрован только если вы используете защищенное соединение (например, HTTPS): ВКонтакте не сможет прочитать то, что вы передаете. Не рекомендуется использовать незащищенное соединение (например, HTTP): ваш трафик может быть легко прочитан.

Для установки потребуется аккаунт ВКонтакте с подтвержденным номером телефона и двухфакторной аутентификацией. Нужно будет создать сообщество и выдать ключ доступа к нему. Опционально нужно будет выдать ключ доступа к вашему аккаунту. Все ключи доступны только вам и не передаются куда-либо. После настройки программа должна быть запущена в двух местах: в условиях белого списка и за пределами белого списка.

## Установка

### Сообщество

#### 1. Создайте

Откройте ВКонтакте, нажмите Сообщества, нажмите Создать сообщество, введите любое название и тематику, нажмите Создать сообщество, нажмите Перейти в сообщество.

Адресная строка будет иметь вид `https://vk.com/club12345`, где `12345` - ID сообщества. Сохраните этот ID и название сообщества.

#### 2. Настройте

Нажмите Сообщение, напишите что-нибудь, нажмите Отправить.

Предварительно скачайте любое фото на компьютер ([пример](https://vk.com/images/icons/pwa/apple/default.png)). Нажмите Фото, нажмите Добавить фото, выберите любое фото. Адресная строка будет иметь вид `https://vk.com/album-12345_6789`, где `6789` - ID альбома. Сохраните ID альбома. Нажмите на название сообщества.

Нажмите Управление, измените Тип сообщества на Частное, нажмите Сохранить.

Нажмите Разделы, включите раздел Файлы, нажмите Сохранить.

Нажмите Дополнительно, нажмите Работа с API, нажмите Создать ключ, включите все доступы, нажмите Создать, подтвердите действие. Ключ доступа имеет вид `vk1.a.abCdE...`. Скопируйте его полностью и сохраните. Никому не давайте этот ключ доступа.

Нажмите Long Poll API, измените Отключено на Включено, нажмите Типы событий, включите Исходящее сообщение, Фотографии Добавление, Записи на стене Добавление, Комментарии на стене Добавление.

#### 3. Повторите

Для тестирования программы достаточно одного сообщества. Но при реальном использовании вы быстро столкнетесь с лимитами VK API. Рекомендуется создать и настроить 5 сообществ. При необходимости можно и больше.

### Аккаунт

#### 1. ID

Откройте ВКонтакте, нажмите на свою аватарку в правом верхнем углу, нажмите Управление аккаунтом VK ID, нажмите Мои данные. Под вашим именем будут цифры - это ID. Сохраните его.

#### 2. Ключ доступа

Дайте доступ любому из этих сервисов:

- [aliexpress](https://oauth.vk.com/authorize?client_id=7493445&scope=65540&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [instagram](https://oauth.vk.com/authorize?client_id=3698024&scope=65540&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [prisma](https://oauth.vk.com/authorize?client_id=5530956&scope=65540&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [kate mobile](https://oauth.vk.com/authorize?client_id=2685278&scope=65540&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [vfeed](https://oauth.vk.com/authorize?client_id=4083558&scope=65540&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)

Сам сервис не будет иметь доступа к вашему аккаунту. Доступ будет иметь только тот, у кого будет ключ, а будет он только у вас. Если вы все равно не хотите давать доступ, то смотрите [Без доступа к аккаунту](#без-доступа-к-аккаунту).

Нажмите Продолжить как.

Адресная строка будет иметь вид `https://oauth.vk.com/blank.html#access_token=vk1.a.abCdE...`. Ключ доступа имеет вид `vk1.a.abCdE...`. Скопируйте весь ключ доступа до знака `&`, не копируйте сам знак. Сохраните его. Никому не давайте этот ключ доступа.

Вы можете отозвать выданный ключ доступа. Откройте ВКонтакте, нажмите на свою аватарку в правом верхнем углу, нажмите Управление аккаунтом VK ID, нажмите Сервисы и сайты, нажмите на сервис которому вы дали доступ, нажмите Отозвать доступ.

#### 3. Имя

Придумайте и сохраните любое имя для идентификации выданного ключа доступа. Например, если вы выдали доступ `aliexpress`, то можете использовать имя `aliexpress`.

#### 4. Повторите

Для тестирования программы достаточно одного аккаунта. Но при реальном использовании вы быстро столкнетесь с лимитами VK API. Рекомендуется создать и настроить 2 аккаунта. При необходимости можно и больше. При этом ID может быть одинаковым, но ключи доступа должны быть разные.

### Программа

vk-proxy должен быть запущен на клиенте и сервере. Инструкция приведена для сервера на Debian Linux. Для клиента или сервера на другой ОС адаптируйте инструкцию самостоятельно.

Сначала устанавливайте на сервере, потом копируйте конфиг на клиенте. На клиенте достаточно скачать архив, настроить конфиг и запускать программу по необходимости.

Подразумевается, что пользователь сервера - `root`. Если нет, то запускайте команды с помощью `sudo`, например `sudo apt update`.

#### 1. Установите зависимости

```bash
apt update
apt install -y zbar-tools
```

На Windows установка [ZBar](https://github.com/mchehab/zbar) затруднительна. Рекомендуется использовать [WSL](https://learn.microsoft.com/windows/wsl/install) или [выключить использование QR-кодов](#без-доступа-к-аккаунту).

#### 2. Скачайте архив

Откройте [Releases](https://github.com/srgykuz/vk-proxy/releases), раскройте Assets, скопируйте ссылку на версию для вашей ОС. Выполните:

```bash
wget -O vk-proxy.tar.gz <ССЫЛКА>
mkdir vk-proxy
tar -xzf vk-proxy.tar.gz -C vk-proxy
cd vk-proxy
```

#### 3. Установите программу

```bash
mkdir /var/log/vk-proxy
touch /var/log/vk-proxy/output.txt
chown nobody:nogroup /var/log/vk-proxy/output.txt

mkdir /usr/local/etc/vk-proxy
mv vk-proxy /usr/local/bin/
mv config.json /usr/local/etc/vk-proxy/
mv vk-proxy.service /etc/systemd/system/

systemctl daemon-reload
systemctl enable vk-proxy
```

#### 4. Сгенерируйте секрет

```bash
vk-proxy -secret
```

Сохраните его. На клиенте и сервере используйте одинаковый секрет.

#### 5. Заполните конфиг

Откройте конфиг:

```bash
nano /usr/local/etc/vk-proxy/config.json
```

Заполните конфиг значениями которые вы сохраняли ранее.

<details>

<summary>
Пример конфига
</summary>

```json
{
    "log": {
        "output": "/var/log/vk-proxy/output.txt"
    },
    "session": {
        "secret": "abc123"
    },
    "socks": {
        "listenPort": 1080
    },
    "api": {
        "unathorized": false
    },
    "qr": {
        "zbarPath": "zbarimg"
    },
    "clubs": [
        {
            "name": "test",
            "id": "12345",
            "accessToken": "vk1.a.abCdE",
            "albumID": "6789"
        }
    ],
    "users": [
        {
            "name": "aliexpress",
            "id": "123",
            "accessToken": "vk1.a.eDcBA"
        }
    ]
}
```

</details>

Сохраните конфиг: Ctrl+O + Enter. Закройте конфиг: Ctrl+X.

`log.output` на клиенте оставьте пустым, чтобы вывод программы отображался сразу в терминале. В остальном конфиг на клиенте может быть идентичным.

#### 6. Запустите программу

```bash
systemctl start vk-proxy
```

#### 7. Проверьте программу

Запустите следующие команды и убедитесь в отсутствии ошибок. Закройте команды с помощью Ctrl+C.

Эта команда должна отобразить `active (running)`:

```bash
systemctl status vk-proxy
```

Эти команды не должны содержать ошибок:

```bash
journalctl -u vk-proxy
```

```bash
tail -n 100 /var/log/vk-proxy/output.txt
```

Вы можете смотреть логи программы используя последнюю `tail` команду. Смотрите логи, когда что-то идет не так.

#### 8. Запустите программу на клиенте

На клиенте достаточно установить зависимости, скачать архив, заполнить конфиг и запустить программу сразу в терминале:

```bash
./vk-proxy
```

Запустится SOCKS-прокси по адресу `127.0.0.1:1080`. Установите его там где нужно проксировать трафик используя vk-proxy. Обратите внимание на [Flood control](#flood-control).

#### 9. Протестируйте программу

На клиенте откройте новую вкладку терминала и запустите эти команды:

```bash
curl --verbose --socks5 127.0.0.1:1080 https://www.youtube.com/
```

Вы должны увидеть код страницы и его окончание `</html>`.

```bash
curl --verbose --socks4 127.0.0.1:1080 https://api.ipapi.is/
```

Вы должны увидеть информацию об айпи сервера.

## Конфиг

Возможные настройки и их значения по умолчанию.

<details>

<summary>
Описание
</summary>

```jsonc
{
    "log": {
        "level": 0, // Уровень логов. -4 - debug, 0 - info, 4 - warn, 8 - error
        "output": "", // Путь к файлу куда сохранять логи. Если пусто, то выводить логи в терминал
        "payload": false // Логировать тела запросов и ответов
    },
    "session": {
        "timeout": 30000, // Если соединение бездействует в течении этого времени, то оно будет закрыто. В миллисекундах. 0 выключает проверку
        "secret": "" // Ключ шифрования
    },
    "socks": {
        "listenHost": "127.0.0.1", // Запустить SOCKS-прокси на этом адресе
        "listenPort": 1080, // Запустить SOCKS-прокси на этом порту
        "forwardSize": 1048576, // Максимальный размер пересылаемого датаграмма. В байтах
        "forwardInterval": 500 // Буферизировать проксируемые данные в течении этого времени перед упаковкой их в датаграммы. В миллисекундах
    },
    "api": {
        "unathorized": false // Не использовать user.accessToken
    },
    "qr": {
        "zbarPath": "zbarimg", // Путь к программе ZBar
        "saveDir": "" // Куда сохранять временные QR-коды. Если пусто, то используется временная директория системы
    },
    "clubs": [ // Описания сообществ
        {
            "name": "", // Имя для идентификации в логах
            "id": "", // ID сообщества
            "accessToken": "", // Ключ доступа к API
            "albumID": "" // ID альбома куда загружать QR-коды
        }
    ],
    "users": [ // Описания пользователей
        {
            "name": "", // Имя для идентификации в логах
            "id": "", // ID пользователя
            "accessToken": "" // Ключ доступа к API
        }
    ]
}
```

</details>

Указать путь к конфигу:

```bash
vk-proxy -config /path/to/config.json
```

По умолчанию используется `config.json` в директории программы.

## Без доступа к аккаунту

Если вы не хотите давать доступ к аккаунту, то в конфиге укажите:

```json
{
    "api": {
        "unathorized": true
    }
}
```

В этом случае `user.accessToken` использоваться не будет. Использование QR-кодов будет выключено.

При этом вероятность [Flood control](#flood-control) значительно увеличивается.

## Flood control

vk-proxy может начать работать нестабильно или вовсе перестать работать. В логах программы вы увидите ошибку `Flood control`. Это значит, что вы передаете слишком много трафика или слишком быстро. vk-proxy не рассчитан на такую работу. VK API имеет ограничения, поэтому передавать много трафика не получится. Используйте vk-proxy только для минимального доступа к важным сервисам.

Подождите некоторое время для обнуления достигнутых лимитов и повторите запрос. Во время использования vk-proxy старайтесь делать паузы между запросами.

Для минимизации этой ошибки:

- создайте больше сообществ и аккаунтов
- проксируйте только определенные сервисы, а не весь трафик целиком
- устанавливайте прокси на уровне браузера или даже сайта, а не на уровне всей системы
- отключите ненужный контент (картинки, видео, стили и т.п)
- используйте блокировщик рекламы
- используйте минималистичные версии сайтов
- используйте режим экономии трафика
- если безопасность и приватность неважны, то используйте HTTP-версию сайта вместо HTTPS

## V2Ray

Вы можете использовать vk-proxy в связке с V2Ray.

<details>

<summary>
Пример конфига V2Ray
</summary>

```json
{
    "log": {
        "loglevel": "info"
    },
    "inbounds": [
        {
            "protocol": "socks",
            "listen": "127.0.0.1",
            "port": 2000,
            "settings": {
                "udp": true
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            }
        }
    ],
    "outbounds": [
        {
            "tag": "direct",
            "protocol": "freedom"
        },
        {
            "tag": "vk-proxy",
            "protocol": "socks",
            "settings": {
                "servers": [
                    {
                        "address": "127.0.0.1",
                        "port": 1080
                    }
                ]
            }
        }
    ],
    "routing": {
        "domainStrategy": "IPOnDemand",
        "rules": [
            {
                "type": "field",
                "domains": [
                    "google.com",
                    "gstatic.com",
                    "googleusercontent.com",
                    "wikipedia.org",
                    "wikimedia.org"
                ],
                "outboundTag": "vk-proxy"
            }
        ]
    }
}
```

</details>
