# vk-proxy

Проксирование трафика через ВКонтакте используя VK API. Цель этого проекта - обход белого списка и получение минимального доступа к глобальному интернету.

**vk-proxy не может быть использован для полноценной замены VPN и прокси.** VK API имеет жесткие ограничения, поэтому с помощью этой программы вы едва сможете использовать, например, Google или Wikipedia, не говоря уже о более ресурсоемких сайтах и приложениях. [Telegram](#telegram) будет работать только в текстовом режиме.

Передаваемый трафик зашифрован только если вы используете защищенное соединение (например, HTTPS): ВКонтакте не сможет прочитать то, что вы передаете. Не рекомендуется использовать незащищенное соединение (например, HTTP): ваш трафик может быть легко прочитан.

Для установки потребуется аккаунт ВКонтакте с подтвержденным номером телефона и двухфакторной аутентификацией. Нужно будет создать сообщество и выдать ключ доступа к нему. Опционально нужно будет выдать ключ доступа к аккаунту. Все ключи доступны только вам и не передаются куда-либо.

Программа должна быть запущена в двух местах: на устройстве в условиях белого списка и на устройстве за пределами белого списка. Второе устройство не обязательно должно быть сервером с публичным статическим айпи. Например, можно запустить программу на телефоне с мобильным интернетом, где белые списки действуют, и на компьютере с проводным интернетом, где белые списки не действуют.

## Установка

Выполните установку в следующем порядке:

1. сообщество
2. аккаунт
3. устройство за пределами белого списка
4. устройство в условиях белого списка

Конфиг на устройствах должен быть одинаковыми, за исключением нескольких настроек не влияющих на передачу данных, иначе программа будет работать некорректно.

Программа может быть запущена как постоянно, так и по необходимости.

### Сообщество

#### 1. Создайте

Откройте ВКонтакте, нажмите Сообщества, нажмите Создать сообщество, введите любое название и тематику, нажмите Создать сообщество, нажмите Перейти в сообщество.

Адресная строка будет иметь вид `https://vk.com/club12345`, где `12345` - ID сообщества. Сохраните этот ID и название сообщества.

#### 2. Настройте

Нажмите Сообщение, напишите что-нибудь, нажмите Отправить, отключите уведомления. Вернитесь обратно на страницу сообщества, нажав два раза на название сообщества.

Нажмите Управление, измените Тип сообщества на Частное, нажмите Сохранить.

Нажмите Разделы, включите разделы Файлы и Товары, нажмите Сохранить.

Нажмите Дополнительно, нажмите Работа с API, нажмите Создать ключ, включите все доступы, нажмите Создать, подтвердите действие. Ключ доступа имеет вид `vk1.a.abCdE...`. Скопируйте его полностью и сохраните. Никому не давайте этот ключ доступа.

Нажмите Long Poll API, измените Отключено на Включено, нажмите Типы событий, включите всё. Вернитесь обратно, нажав на название сообщества.

Предварительно скачайте [stub.jpg](/stub.jpg). Нажмите Фото, нажмите Добавить фото, выберите [stub.jpg](/stub.jpg). Нажмите на загруженное фото. Адресная строка будет иметь вид `https://vk.com/album-12345_6789?z=photo-12345_9876`, где `6789` - это ID альбома, а `9876` - это ID фото. Сохраните оба ID. Вернитесь обратно, нажав на название сообщества.

Предварительно скачайте [stub.mp4](/stub.mp4). Нажмите Видео, наведите на Добавить, нажмите Добавить видео, нажмите Выбрать файл, выберите [stub.mp4](/stub.mp4). Ссылка на видео, справа, будет иметь вид `https://vk.com/video-12345_7890`, где `7890` - ID видео. Сохраните этот ID. Нажмите Далее, нажмите Далее, нажмите Опубликовать. Закройте открывшуюся страницу ВК Видео и вернитесь обратно на страницу сообщества.

Где вы нажимали Фото и Видео, прокрутите вправо. Нажмите Товары, нажмите Добавить товары, введите любые: категория, название, описание. Нажмите Выберите изображение, выберите ранее загруженное фото, нажмите Выбрать фото, нажмите Сохранить изменения, нажмите Создать товар. Нажмите Товары, нажмите на созданный товар. Адресная строка будет иметь вид `https://vk.com/market/product/12345-8901`, где `8901` - ID товара. Сохраните этот ID.

#### 3. Повторите

Для тестирования программы достаточно одного сообщества. Но при реальном использовании вы быстро столкнетесь с лимитами VK API. Рекомендуется создать и настроить 5 сообществ. При необходимости можно и больше.

### Аккаунт

#### 1. ID

Откройте ВКонтакте, нажмите на свою аватарку в правом верхнем углу, нажмите Управление аккаунтом VK ID, нажмите Мои данные. Под вашим именем будут цифры - это ID. Сохраните его.

#### 2. Ключ доступа

Дайте доступ любому из этих сервисов:

- [aliexpress](https://oauth.vk.com/authorize?client_id=7493445&scope=134545428&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [instagram](https://oauth.vk.com/authorize?client_id=3698024&scope=134545428&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [prisma](https://oauth.vk.com/authorize?client_id=5530956&scope=134545428&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [kate mobile](https://oauth.vk.com/authorize?client_id=2685278&scope=134545428&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)
- [vfeed](https://oauth.vk.com/authorize?client_id=4083558&scope=134545428&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1)

Сам сервис не будет иметь доступа к аккаунту. Доступ будет иметь только тот, у кого будет ключ, а будет он только у вас. Если вы все равно не хотите давать доступ, то смотрите [Без доступа к аккаунту](#без-доступа-к-аккаунту).

Нажмите Продолжить как.

Адресная строка будет иметь вид `https://oauth.vk.com/blank.html#access_token=vk1.a.abCdE...`. Ключ доступа имеет вид `vk1.a.abCdE...`. Скопируйте весь ключ доступа до знака `&`, не копируйте сам знак. Сохраните его. Никому не давайте этот ключ доступа.

Вы можете отозвать выданный ключ доступа. Откройте ВКонтакте, нажмите на свою аватарку в правом верхнем углу, нажмите Управление аккаунтом VK ID, нажмите Сервисы и сайты, нажмите на сервис которому вы дали доступ, нажмите Отозвать доступ.

#### 3. Имя

Придумайте и сохраните любое имя для идентификации выданного ключа доступа. Например, если вы выдали доступ сервису `aliexpress`, то можете использовать имя `aliexpress`.

#### 4. Повторите

Для тестирования программы достаточно одного аккаунта. Но при реальном использовании вы быстро столкнетесь с лимитами VK API. Рекомендуется создать и настроить 2 аккаунта. При необходимости можно и больше. При этом ID может быть одинаковым, но ключи доступа должны быть разные.

### Linux

Рекомендуется использовать Debian или Ubuntu. Также можно использовать [Docker](#docker).

В терминале выполните:

```bash
whoami
```

Если пользователь не `root`, то запускайте следующие команды с помощью `sudo`, например `sudo apt update`.

#### 1. Установите зависимости

```bash
apt update
apt install -y wget nano zbar-tools
```

#### 2. Скачайте архив

Откройте [Releases](https://github.com/srgykuz/vk-proxy/releases), раскройте Assets последней версии, скопируйте ссылку на Linux-версию. Выполните:

```bash
wget -O vk-proxy.tar.gz <ССЫЛКА>
mkdir vk-proxy
tar -xzf vk-proxy.tar.gz -C vk-proxy
cd vk-proxy
```

#### 3. Установите программу

```bash
mkdir /var/log/vk-proxy
touch /var/log/vk-proxy/output.log
chown nobody:nogroup /var/log/vk-proxy/output.log
mv logrotate.txt /etc/logrotate.d/vk-proxy

mkdir /usr/local/etc/vk-proxy
mv vk-proxy /usr/local/bin/
mv config.json /usr/local/etc/vk-proxy/
mv systemd.txt /etc/systemd/system/vk-proxy.service

systemctl daemon-reload
systemctl enable vk-proxy
```

#### 4. Сгенерируйте секрет

Если секрет не сгенерирован ранее, то выполните:

```bash
vk-proxy -secret
```

Сохраните его.

#### 5. Заполните конфиг

Откройте конфиг:

```bash
nano /usr/local/etc/vk-proxy/config.json
```

Заполните конфиг значениями которые вы сохраняли ранее.

<details>

<summary>
Пример конфига
</summary>

```json
{
    "log": {
        "output": "/var/log/vk-proxy/output.log"
    },
    "session": {
        "secret": "abc123"
    },
    "socks": {
        "listenHost": "127.0.0.1",
        "listenPort": 1080
    },
    "api": {
        "unathorized": false
    },
    "qr": {
        "zbarPath": "zbarimg"
    },
    "clubs": [
        {
            "name": "test",
            "id": "12345",
            "accessToken": "vk1.a.abCdE",
            "albumID": "6789",
            "photoID": "9876",
            "videoID": "7890",
            "marketID": "8901"
        }
    ],
    "users": [
        {
            "name": "aliexpress",
            "id": "123",
            "accessToken": "vk1.a.eDcBA"
        }
    ]
}
```

</details>

Сохраните конфиг: Ctrl+O + Enter. Закройте конфиг: Ctrl+X.

#### 6. Запустите программу

```bash
systemctl start vk-proxy
```

Это запустит программу в фоновом режиме. После перезагрузки компьютера она будет запущена автоматически.

Для перезапуска программы выполните:

```bash
systemctl stop vk-proxy
systemctl start vk-proxy
```

#### 7. Проверьте программу

Выполните следующие команды и убедитесь в отсутствии ошибок. После проверки закройте команды с помощью Ctrl+C.

Эта команда должна отобразить `active (running)`:

```bash
systemctl status vk-proxy
```

Эти команды не должны содержать ошибок:

```bash
journalctl -u vk-proxy
```

```bash
tail -n 100 /var/log/vk-proxy/output.log
```

Если где-то есть ошибка, то устраните ее, перезапустите программу и снова убедитесь в отсутствии ошибок.

Вы можете смотреть логи программы используя последнюю `tail` команду. Смотрите логи, когда что-то идет не так.

### Windows

На Windows установка [ZBar](https://github.com/mchehab/zbar) затруднительна. Рекомендуется использовать [WSL](https://learn.microsoft.com/windows/wsl/install) и запускать [Linux-версию](#linux). Также можно использовать [Docker](#docker).

Для Windows-версии необходимо [выключить использование QR-кодов](#без-доступа-к-аккаунту).

#### 1. Скачайте архив

Откройте [Releases](https://github.com/srgykuz/vk-proxy/releases), раскройте Assets последней версии, скачайте Windows-версию.

#### 2. Установите программу

Распакуйте архив, перейдите в созданную папку, нажмите правую кнопку мыши, нажмите "Открыть в терминале".

#### 3. Сгенерируйте секрет

Выполните [это](#4-сгенерируйте-секрет). Замените `vk-proxy` на `./vk-proxy.exe`.

#### 4. Заполните конфиг

Выполните [это](#5-заполните-конфиг). Заполните конфиг в текущей папке.

- в `log.output` укажите `""`
- в `qr.zbarPath` укажите `""`. На втором устройстве тоже укажите `""`

#### 5. Запустите программу

```bash
./vk-proxy.exe
```

После закрытия терминала программа будет остановлена. Чтобы запустить ее снова, откройте папку в терминале и запустите программу.

### macOS

Адаптируйте инструкцию для [Linux](#linux) или [Windows](#windows) самостоятельно. Также можно использовать [Docker](#docker).

### Docker

#### 1. Скачайте архив

Откройте [Releases](https://github.com/srgykuz/vk-proxy/releases), раскройте Assets последней версии, скачайте `Source code`. `zip` для Windows, `tar.gz` для Linux и Mac.

#### 2. Установите программу

Распакуйте архив, перейдите в созданную папку, откройте её в терминале.

Клонируйте файл `config.template.json`, назовите новый файл `config.json`.

Выполните:

```bash
docker compose build
```

#### 3. Сгенерируйте секрет

Выполните [это](#4-сгенерируйте-секрет). Используйте команду:

```bash
docker compose run --rm vk-proxy -secret
```

#### 4. Заполните конфиг

Выполните [это](#5-заполните-конфиг). Заполните конфиг в текущей папке.

- в `log.output` укажите `""`
- в `socks.listenHost` укажите `"0.0.0.0"`

#### 5. Запустите программу

```bash
docker compose up -d
```

Это запустит программу в фоновом режиме. После перезагрузки компьютера она будет запущена автоматически.

Для перезапуска программы выполните:

```bash
docker compose restart
```

Для просмотра логов выполните:

```bash
docker compose logs -n 100
```

### Android

Предварительно установите и запустите [Termux](https://github.com/termux/termux-app). Рекомендуется устанавливать версию из [F-Droid](https://f-droid.org/en/packages/com.termux).

Для Android-версии необходимо [выключить использование QR-кодов](#без-доступа-к-аккаунту).

#### 1. Установите зависимости

```bash
pkg update
pkg install -y wget nano zbar proot
```

#### 2. Скачайте архив

Выполните [это](#2-скачайте-архив). Используйте Android-версию.

#### 3. Сгенерируйте секрет

Выполните [это](#4-сгенерируйте-секрет). Замените `vk-proxy` на `./vk-proxy`.

#### 4. Заполните конфиг

Откройте конфиг:

```bash
nano config.json
```

И выполните [это](#5-заполните-конфиг).

- в `log.output` укажите `""`
- в `qr.zbarPath` укажите `""`. На втором устройстве тоже укажите `""`

Если печатать на телефоне утомительно, то заполните конфиг на компьютере, отправьте текст на телефон, скопируйте этот текст и вставьте в конфиг с нуля:

```bash
rm config.json
nano config.json
```

#### 5. Запустите программу

```bash
termux-chroot ./vk-proxy
```

После закрытия терминала программа будет остановлена. Чтобы запустить ее снова, откройте папку в терминале и запустите программу.

Для перезапуска программы остановите ее с помощью Ctrl+C и запустите снова.

## Использование

После установки и запуска будет доступен SOCKS-прокси по адресу `127.0.0.1:1080`. На устройстве в условиях белого списка установите его там, где нужно проксировать трафик через ВК.

Обратите внимание на [Flood control](#flood-control). Не ожидайте быстрой загрузки страниц, делайте паузы между запросами, передавайте как можно меньше трафика. Ещё раз: vk-proxy расчитан лишь на минимальный доступ к глобальному интернету.

Рекомендуется использовать vk-proxy в связке с любым [V2Ray-клиентом](#v2ray) для настройки точечного роутинга. Например, отправляйте весь трафик Google через vk-proxy, а остальной трафик пускайте напрямую.

### Проверка

В Linux и macOS используйте `curl`, в Windows - `curl.exe`. В терминале выполните:

```bash
curl --verbose --socks5 127.0.0.1:1080 https://www.google.com/
```

Вы должны увидеть код страницы и его окончание `</html>`.

```bash
curl --verbose --socks4 127.0.0.1:1080 https://api.ipapi.is/
```

Вы должны увидеть информацию об айпи устройства за пределами белого списка.

## Конфиг

Возможные настройки и их значения по умолчанию.

<details>

<summary>
Описание
</summary>

```jsonc
{
    "log": {
        "level": 0, // Уровень логов. -4 - debug, 0 - info, 4 - warn, 8 - error
        "output": "", // Путь к файлу куда сохранять логи. Если пусто, то выводить логи в терминал
        "payload": false // Логировать тела запросов и ответов
    },
    "session": {
        "timeout": 30000, // Если соединение бездействует в течение этого времени, то оно будет закрыто. В миллисекундах. 0 выключает проверку
        "secret": "" // Ключ шифрования
    },
    "socks": {
        "listenHost": "127.0.0.1", // Запустить SOCKS-прокси на этом адресе
        "listenPort": 1080, // Запустить SOCKS-прокси на этом порту
        "forwardSize": 1048576, // Максимальный размер пересылаемого датаграмма. В байтах
        "forwardInterval": 500 // Буферизировать проксируемые данные в течение этого времени перед упаковкой их в датаграммы. В миллисекундах
    },
    "api": {
        "unathorized": false // Не использовать user.accessToken
    },
    "qr": {
        "zbarPath": "zbarimg", // Путь к программе ZBar. Если пусто, то выключает использование QR-кодов
        "saveDir": "" // Куда сохранять временные QR-коды. Если пусто, то используется временная директория системы
    },
    "clubs": [ // Описания сообществ
        {
            "name": "", // Имя для идентификации в логах
            "id": "", // ID сообщества
            "accessToken": "", // Ключ доступа к API
            "albumID": "", // ID альбома куда загружать QR-коды
            "photoID": "", // ID загруженного фото
            "videoID": "", // ID загруженного видео
            "marketID": "" // ID созданного товара
        }
    ],
    "users": [ // Описания пользователей
        {
            "name": "", // Имя для идентификации в логах
            "id": "", // ID пользователя
            "accessToken": "" // Ключ доступа к API
        }
    ]
}
```

</details>

Указать путь к конфигу:

```bash
vk-proxy -config /path/to/config.json
```

По умолчанию используется `config.json` в директории программы.

## Без доступа к аккаунту

Если вы не хотите давать доступ к аккаунту, то в конфиге на всех устройствах укажите:

```json
{
    "api": {
        "unathorized": true
    }
}
```

В этом случае `user.accessToken` использоваться не будет. Использование QR-кодов будет выключено.

При этом вероятность [Flood control](#flood-control) значительно увеличивается.

## Flood control

vk-proxy может начать работать нестабильно или вовсе перестать работать. В логах программы вы увидите ошибку `Flood control`. Это значит, что вы передаете слишком много трафика или слишком быстро. vk-proxy не рассчитан на такую работу. VK API имеет ограничения, поэтому передать много трафика не получится. Используйте vk-proxy только для минимального доступа к важным сервисам.

Подождите некоторое время для обнуления достигнутых лимитов и повторите запрос. Во время использования vk-proxy сократите количество передаваемого трафика и делайте паузы между запросами.

Для минимизации этой ошибки:

- создайте больше сообществ и аккаунтов
- проксируйте только определенные сервисы, а не весь трафик целиком
- устанавливайте прокси на уровне браузера или даже сайта, а не на уровне всей системы
- отключите ненужный контент (картинки, видео, стили и т.п)
- используйте блокировщик рекламы
- используйте минималистичные версии сайтов
- используйте режим экономии трафика
- если безопасность и приватность неважны, то используйте HTTP-версию сайта вместо HTTPS

## V2Ray

Рекомендуется использовать vk-proxy в связке с любым V2Ray-клиентом. В этом случае вы сможете настроить точечный роутинг и обеспечить более широкую поддержку входящих интерфейсов.

Примеры V2Ray-клиентов:

- [v2rayN](https://github.com/2dust/v2rayN) (Linux, Windows, macOS)
- [v2rayNG](https://github.com/2dust/v2rayNG) (Android)

<details>

<summary>
Пример конфига V2Ray
</summary>

```json
{
    "log": {
        "loglevel": "info"
    },
    "inbounds": [
        {
            "protocol": "socks",
            "listen": "127.0.0.1",
            "port": 2000,
            "settings": {
                "udp": false
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            }
        }
    ],
    "outbounds": [
        {
            "tag": "direct",
            "protocol": "freedom"
        },
        {
            "tag": "vk-proxy",
            "protocol": "socks",
            "settings": {
                "servers": [
                    {
                        "address": "127.0.0.1",
                        "port": 1080
                    }
                ]
            }
        }
    ],
    "routing": {
        "domainStrategy": "IPOnDemand",
        "rules": [
            {
                "type": "field",
                "domains": [
                    "google.com",
                    "gstatic.com",
                    "googleusercontent.com",
                    "wikipedia.org",
                    "wikimedia.org",
                    "telegram.org"
                ],
                "network": "tcp",
                "outboundTag": "vk-proxy"
            }
        ]
    }
}
```

</details>

<details>

<summary>
Пример конфига v2rayN и v2rayNG
</summary>

Интерфейс:

```text
socks://Og%3D%3D@127.0.0.1:1080#vk-proxy
```

Роутинг:

```json
[
    {
        "domain": [
            "google.com",
            "gstatic.com",
            "googleusercontent.com",
            "wikipedia.org",
            "wikimedia.org",
            "telegram.org"
        ],
        "enabled": true,
        "locked": true,
        "network": "tcp",
        "outboundTag": "proxy",
        "remarks": "vk-proxy: proxy"
    },
    {
        "enabled": true,
        "locked": true,
        "outboundTag": "direct",
        "port": "0-65535",
        "remarks": "vk-proxy: direct"
    }
]
```

</details>

## Telegram

Рекомендуется использовать веб-версию - [https://web.telegram.org](https://web.telegram.org/). Обязательно отключите медиаконтент: нажмите Настройки, нажмите Данные и память, выключите Загружать автоматически или выключите всю автозагрузку. Не скачивайте фото и видео, используйте только текст.
